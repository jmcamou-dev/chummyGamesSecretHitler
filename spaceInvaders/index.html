<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2-Player Space Shooter</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .game-container {
            text-align: center;
        }
        canvas {
            border: 2px solid #fff;
            background: linear-gradient(180deg, #000428 0%, #004e92 100%);
        }
        .controls {
            margin-top: 10px;
            font-size: 14px;
        }
        .score {
            font-size: 20px;
            margin-bottom: 10px;
        }
        .connection-panel {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .connection-panel input, .connection-panel button {
            margin: 5px;
            padding: 8px 15px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
        }
        .connection-panel button {
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }
        .connection-panel button:hover {
            background: #45a049;
        }
        .connection-panel button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .status {
            color: #00ff00;
            margin: 10px 0;
        }
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        .restart-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 10px;
        }
        .restart-btn:hover {
            background: #45a049;
        }
        .player-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .player1 { color: #00ff00; }
        .player2 { color: #ff6600; }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="connection-panel" id="connectionPanel">
            <h3>2-Player Space Shooter</h3>
            <div>
                <button onclick="hostGame()">Host Game</button>
                <button onclick="joinGame()">Join Game</button>
            </div>
            <div id="hostInfo" style="display: none;">
                <p>Your Game ID: <span id="hostId"></span></p>
                <p>Share this ID with your friend!</p>
            </div>
            <div id="joinInfo" style="display: none;">
                <input type="text" id="gameId" placeholder="Enter Game ID">
                <button onclick="connectToHost()">Connect</button>
            </div>
            <div class="status" id="status">Choose Host or Join to start</div>
        </div>

        <div id="gameUI" style="display: none;">
            <div class="player-info">
                <div class="player1">Player 1 Score: <span id="score1">0</span></div>
                <div class="player2">Player 2 Score: <span id="score2">0</span></div>
            </div>
            <canvas id="gameCanvas" width="800" height="600"></canvas>
            <div class="controls">
                <div class="player1">Player 1: WASD to move • SPACE to shoot</div>
                <div class="player2">Player 2: ARROW KEYS to move • ENTER to shoot</div>
                <div>Work together to destroy red enemies!</div>
            </div>
        </div>

        <div id="gameOver" class="game-over" style="display: none;">
            <h2>Game Over!</h2>
            <p class="player1">Player 1 Score: <span id="finalScore1">0</span></p>
            <p class="player2">Player 2 Score: <span id="finalScore2">0</span></p>
            <button class="restart-btn" onclick="restartGame()">Play Again</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const score1Element = document.getElementById('score1');
        const score2Element = document.getElementById('score2');
        const gameOverElement = document.getElementById('gameOver');
        const finalScore1Element = document.getElementById('finalScore1');
        const finalScore2Element = document.getElementById('finalScore2');
        const statusElement = document.getElementById('status');
        const connectionPanel = document.getElementById('connectionPanel');
        const gameUI = document.getElementById('gameUI');

        // Networking
        let peer = null;
        let conn = null;
        let isHost = false;
        let isConnected = false;

        // Game state
        let gameRunning = false;
        let scores = { player1: 0, player2: 0 };
        let keys = {};

        // Players
        const players = {
            player1: {
                x: canvas.width / 4,
                y: canvas.height - 50,
                width: 30,
                height: 30,
                speed: 5,
                color: '#00ff00'
            },
            player2: {
                x: (canvas.width * 3) / 4,
                y: canvas.height - 50,
                width: 30,
                height: 30,
                speed: 5,
                color: '#ff6600'
            }
        };

        // Arrays for game objects
        let bullets = [];
        let enemies = [];
        let particles = [];

        // Bullet class
        class Bullet {
            constructor(x, y, owner) {
                this.x = x;
                this.y = y;
                this.width = 4;
                this.height = 10;
                this.speed = 7;
                this.owner = owner;
                this.color = owner === 'player1' ? '#ffff00' : '#ff8800';
            }

            update() {
                this.y -= this.speed;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }

            isOffScreen() {
                return this.y < 0;
            }
        }

        // Enemy class
        class Enemy {
            constructor() {
                this.x = Math.random() * (canvas.width - 30);
                this.y = -30;
                this.width = 30;
                this.height = 30;
                this.speed = 2 + Math.random() * 3;
                this.color = '#ff0000';
            }

            update() {
                this.y += this.speed;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                ctx.fillStyle = '#800000';
                ctx.fillRect(this.x + 5, this.y + 5, 20, 10);
                ctx.fillRect(this.x + 10, this.y + 15, 10, 10);
            }

            isOffScreen() {
                return this.y > canvas.height;
            }
        }

        // Particle class
        class Particle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 10;
                this.vy = (Math.random() - 0.5) * 10;
                this.life = 30;
                this.color = `hsl(${Math.random() * 60 + 10}, 100%, 50%)`;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life--;
                this.vx *= 0.98;
                this.vy *= 0.98;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.life / 30;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, 3, 3);
                ctx.restore();
            }

            isDead() {
                return this.life <= 0;
            }
        }

        // Networking functions
        function hostGame() {
            peer = new Peer();
            peer.on('open', (id) => {
                document.getElementById('hostId').textContent = id;
                document.getElementById('hostInfo').style.display = 'block';
                document.getElementById('joinInfo').style.display = 'none';
                statusElement.textContent = 'Waiting for player to join...';
                isHost = true;
            });

            peer.on('connection', (connection) => {
                conn = connection;
                setupConnection();
                statusElement.textContent = 'Player 2 connected! Starting game...';
                setTimeout(startGame, 1000);
            });
        }

        function joinGame() {
            document.getElementById('joinInfo').style.display = 'block';
            document.getElementById('hostInfo').style.display = 'none';
            statusElement.textContent = 'Enter the Host\'s Game ID';
        }

        function connectToHost() {
            const hostId = document.getElementById('gameId').value.trim();
            if (!hostId) return;

            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(hostId);
                setupConnection();
                statusElement.textContent = 'Connecting to host...';
                isHost = false;
            });
        }

        function setupConnection() {
            conn.on('open', () => {
                isConnected = true;
                if (!isHost) {
                    statusElement.textContent = 'Connected! Starting game...';
                    setTimeout(startGame, 1000);
                }
            });

            conn.on('data', (data) => {
                handleNetworkData(data);
            });

            conn.on('close', () => {
                isConnected = false;
                statusElement.textContent = 'Connection lost';
            });
        }

        function sendData(data) {
            if (conn && isConnected) {
                conn.send(data);
            }
        }

        function handleNetworkData(data) {
            switch (data.type) {
                case 'playerUpdate':
                    if (isHost && data.player === 'player2') {
                        players.player2.x = data.x;
                        players.player2.y = data.y;
                    } else if (!isHost && data.player === 'player1') {
                        players.player1.x = data.x;
                        players.player1.y = data.y;
                    }
                    break;
                case 'bulletFired':
                    bullets.push(new Bullet(data.x, data.y, data.owner));
                    break;
                case 'gameState':
                    if (!isHost) {
                        enemies = data.enemies.map(e => Object.assign(new Enemy(), e));
                        scores = data.scores;
                        updateScoreDisplay();
                    }
                    break;
                case 'enemyDestroyed':
                    // Create explosion particles
                    for (let i = 0; i < 10; i++) {
                        particles.push(new Particle(data.x, data.y));
                    }
                    break;
            }
        }

        // Event listeners
        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
        });

        document.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });

        // Game functions
        function startGame() {
            connectionPanel.style.display = 'none';
            gameUI.style.display = 'block';
            gameRunning = true;
            gameLoop();
        }

        function spawnEnemy() {
            if (isHost && Math.random() < 0.02) {
                enemies.push(new Enemy());
            }
        }

        function updatePlayers() {
            const currentPlayer = isHost ? 'player1' : 'player2';
            const player = players[currentPlayer];
            const oldX = player.x;
            const oldY = player.y;

            // Player 1 controls (WASD + Space)
            if (currentPlayer === 'player1') {
                if (keys['KeyW'] && player.y > 0) player.y -= player.speed;
                if (keys['KeyS'] && player.y < canvas.height - player.height) player.y += player.speed;
                if (keys['KeyA'] && player.x > 0) player.x -= player.speed;
                if (keys['KeyD'] && player.x < canvas.width - player.width) player.x += player.speed;

                if (keys['Space']) {
                    if (bullets.filter(b => b.owner === 'player1').length === 0 || 
                        bullets.filter(b => b.owner === 'player1').pop().y < player.y - 20) {
                        const bullet = new Bullet(player.x + player.width/2 - 2, player.y, 'player1');
                        bullets.push(bullet);
                        sendData({
                            type: 'bulletFired',
                            x: bullet.x,
                            y: bullet.y,
                            owner: 'player1'
                        });
                    }
                }
            }
            // Player 2 controls (Arrow Keys + Enter)
            else {
                if (keys['ArrowUp'] && player.y > 0) player.y -= player.speed;
                if (keys['ArrowDown'] && player.y < canvas.height - player.height) player.y += player.speed;
                if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
                if (keys['ArrowRight'] && player.x < canvas.width - player.width) player.x += player.speed;

                if (keys['Enter']) {
                    if (bullets.filter(b => b.owner === 'player2').length === 0 || 
                        bullets.filter(b => b.owner === 'player2').pop().y < player.y - 20) {
                        const bullet = new Bullet(player.x + player.width/2 - 2, player.y, 'player2');
                        bullets.push(bullet);
                        sendData({
                            type: 'bulletFired',
                            x: bullet.x,
                            y: bullet.y,
                            owner: 'player2'
                        });
                    }
                }
            }

            // Send position update if moved
            if (oldX !== player.x || oldY !== player.y) {
                sendData({
                    type: 'playerUpdate',
                    player: currentPlayer,
                    x: player.x,
                    y: player.y
                });
            }
        }

        function updateBullets() {
            bullets = bullets.filter(bullet => {
                bullet.update();
                return !bullet.isOffScreen();
            });
        }

        function updateEnemies() {
            enemies = enemies.filter(enemy => {
                enemy.update();
                
                // Check collision with both players
                if (checkCollision(players.player1, enemy) || checkCollision(players.player2, enemy)) {
                    gameOver();
                    return false;
                }
                
                return !enemy.isOffScreen();
            });
        }

        function updateParticles() {
            particles = particles.filter(particle => {
                particle.update();
                return !particle.isDead();
            });
        }

        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        function checkBulletEnemyCollisions() {
            bullets.forEach((bullet, bulletIndex) => {
                enemies.forEach((enemy, enemyIndex) => {
                    if (checkCollision(bullet, enemy)) {
                        // Send explosion effect to other player
                        sendData({
                            type: 'enemyDestroyed',
                            x: enemy.x + enemy.width/2,
                            y: enemy.y + enemy.height/2
                        });

                        // Create explosion particles locally
                        for (let i = 0; i < 10; i++) {
                            particles.push(new Particle(
                                enemy.x + enemy.width/2,
                                enemy.y + enemy.height/2
                            ));
                        }
                        
                        // Remove bullet and enemy
                        bullets.splice(bulletIndex, 1);
                        enemies.splice(enemyIndex, 1);
                        
                        // Increase score for bullet owner
                        if (bullet.owner === 'player1') {
                            scores.player1 += 100;
                        } else {
                            scores.player2 += 100;
                        }
                        updateScoreDisplay();
                    }
                });
            });
        }

        function updateScoreDisplay() {
            score1Element.textContent = scores.player1;
            score2Element.textContent = scores.player2;
        }

        function drawPlayer(player, color) {
            ctx.fillStyle = color;
            ctx.fillRect(player.x, player.y, player.width, player.height);
            
            // Draw player details
            ctx.fillStyle = color === '#00ff00' ? '#00aa00' : '#cc5500';
            ctx.fillRect(player.x + 10, player.y, 10, 15);
            ctx.fillRect(player.x + 5, player.y + 15, 20, 10);
            
            // Draw engine flames
            ctx.fillStyle = '#ff6600';
            ctx.fillRect(player.x + 8, player.y + 30, 6, 8);
            ctx.fillRect(player.x + 16, player.y + 30, 6, 8);
        }

        function drawStars() {
            ctx.fillStyle = '#ffffff';
            for (let i = 0; i < 50; i++) {
                const x = (i * 37) % canvas.width;
                const y = (i * 73 + performance.now() * 0.1) % canvas.height;
                ctx.fillRect(x, y, 1, 1);
            }
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawStars();
            
            drawPlayer(players.player1, players.player1.color);
            drawPlayer(players.player2, players.player2.color);
            
            bullets.forEach(bullet => bullet.draw());
            enemies.forEach(enemy => enemy.draw());
            particles.forEach(particle => particle.draw());
        }

        function gameLoop() {
            if (!gameRunning) return;

            updatePlayers();
            updateBullets();
            updateEnemies();
            updateParticles();
            spawnEnemy();
            checkBulletEnemyCollisions();
            
            // Host syncs game state
            if (isHost) {
                sendData({
                    type: 'gameState',
                    enemies: enemies,
                    scores: scores
                });
            }
            
            render();
            requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            gameRunning = false;
            finalScore1Element.textContent = scores.player1;
            finalScore2Element.textContent = scores.player2;
            gameOverElement.style.display = 'block';
        }

        function restartGame() {
            gameRunning = true;
            scores = { player1: 0, player2: 0 };
            updateScoreDisplay();
            gameOverElement.style.display = 'none';
            
            // Reset game objects
            bullets = [];
            enemies = [];
            particles = [];
            players.player1.x = canvas.width / 4;
            players.player1.y = canvas.height - 50;
            players.player2.x = (canvas.width * 3) / 4;
            players.player2.y = canvas.height - 50;
            
            gameLoop();
        }
    </script>
</body>
</html>