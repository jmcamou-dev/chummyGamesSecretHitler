<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChummyGames</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
</head>
<body>
    <script>

        const button = document.createElement('button');
        button.textContent = 'Hello';
        document.body.appendChild(button);

        const divMain = document.createElement('div');
        divMain.innerHTML = 'Hello-v1.3';
        document.body.appendChild(divMain);
        //---------------------------------
        const MY_PEER_CODE = 'Chummy';
        let mypeer;
        let myconnections = [];

        let isHost = null;
        let myPCID = Array.from({ length: 5 }, () => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[Math.floor(Math.random() * 26)]).join('');
        if (localStorage.getItem('myPCID') !== null) {
            myPCID = localStorage.getItem('myPCID')
            addtodiv(`Old PC ID ${myPCID}`);
        }
        else{
            localStorage.setItem('myPCID', myPCID);
            addtodiv(`NEW PC ID ${myPCID}`);
        }

        function sendMessage(msg){
            myconnections.filter(c => c.open).forEach(c => {c.send(msg);});
        }
        
        function handleHost() {
            mypeer = new Peer(MY_PEER_CODE);
            mypeer.on('open', (id) => {addtodiv("Host-Open");addtodiv(id);isHost = true;}); // True Host
            mypeer.on('connection', function (connection) { // Triggered if a player is connecting 
                addtodiv(connection.peer);
                myconnections.push(connection);
                addtodiv("Host-Connection")
                addtodiv(connection.metadata.pcID);
                connection.on('data', (msg) => {addtodiv("Host-Connection-Data")}); // Triggered if a player is trying to send a message
                connection.on('close', () => {addtodiv("Host-Connection-Close")}); // Triggered if host connection failed
            });
            mypeer.on('error', (err) => {addtodiv("Host-Error");handleJoin();}); // Triggered if there is already a host or something new happend
        }
        
        function handleJoin() {
            isHost = false;
            mypeer = new Peer();
            mypeer.on('open', (id) => { // My random connection is created
                addtodiv("Join-Open");
                addtodiv(id);
                const connection = mypeer.connect(MY_PEER_CODE, { metadata: { pcID: myPCID }});
                myconnections.push(connection);
                addtodiv(connection.peer)
                connection.on('open', () => {addtodiv("Join-Open-Open");}); // Successfully connected with host
                connection.on('data', (msg) => {addtodiv("Join-Open-Data")}); // Message from player or host
                connection.on('close', () => {addtodiv("Join-Open-Close")}); // Host connection failed or my connection failed
                connection.on('error', (err) => {addtodiv("Join-Open-Error")}); // Error while connected to host
            });
            mypeer.on('error', (err) => {addtodiv("Join-Error")});// Error before connecting to host
        }
        function addtodiv(msg){
            divMain.innerHTML += '<br>'+msg;
        }

        handleHost()
        
    </script>
</body>
</html>